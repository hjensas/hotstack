---
- name: Test hotstack-os containerized OpenStack devsetup
  hosts: all
  vars:
    hotstack_os_dir: "{{ ansible_user_dir }}/{{ zuul.project.src_dir }}/devsetup/hotstack-os"
    # Set to 'systemd' to test systemd deployment, 'podman-compose' for compose (default)
    hotstack_deployment_method: "{{ deployment_method | default('podman-compose') }}"
  tasks:

    - name: Install EPEL repository
      become: true
      ansible.builtin.dnf:
        name: epel-release
        state: present

    - name: Install essential packages for build
      become: true
      ansible.builtin.dnf:
        name:
          - podman
          - podman-compose
          - make
          - apt-cacher-ng
        state: present

    - name: Start and enable apt-cacher-ng service
      become: true
      ansible.builtin.systemd:
        name: apt-cacher-ng
        state: started
        enabled: true

    - name: Generate SSH keypair for smoke test
      ansible.builtin.command:
        cmd: ssh-keygen -t ed25519 -f {{ ansible_user_dir }}/.ssh/id_ed25519 -N "" -C "zuul@ci"
        creates: "{{ ansible_user_dir }}/.ssh/id_ed25519.pub"

    - name: Create log directory
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/zuul-output/logs"
        state: directory
        mode: '0755'

    - name: Copy .env.example to .env if not exists
      ansible.builtin.copy:
        src: "{{ hotstack_os_dir }}/.env.example"
        dest: "{{ hotstack_os_dir }}/.env"
        remote_src: true
        force: false
        mode: '0644'

    - name: Configure APT_PROXY for CI build
      ansible.builtin.lineinfile:
        path: "{{ hotstack_os_dir }}/.env"
        regexp: '^APT_PROXY='
        line: 'APT_PROXY=http://host.containers.internal:3142'

    - name: Configure BUILD_PARALLEL for CI build
      ansible.builtin.lineinfile:
        path: "{{ hotstack_os_dir }}/.env"
        regexp: '^BUILD_PARALLEL='
        line: 'BUILD_PARALLEL=1'

    - name: Build, setup, and start hotstack-os services
      become: true
      block:
        - name: Build container images
          args:
            chdir: "{{ hotstack_os_dir }}"
            executable: /bin/bash
          ansible.builtin.shell: |
            set -o pipefail
            make build 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_build.log
          retries: 3
          delay: "{{ 60 | random(start=30, step=1, seed=zuul.build) }}"
          register: build_result
          until: build_result.rc == 0

        - name: Install OpenStack client packages
          args:
            chdir: "{{ hotstack_os_dir }}"
            executable: /bin/bash
          ansible.builtin.shell: |
            set -o pipefail
            make install-client 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_install-client.log

        - name: Setup host environment
          args:
            chdir: "{{ hotstack_os_dir }}"
            executable: /bin/bash
          ansible.builtin.shell: |
            set -o pipefail
            make setup 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_setup.log

        - name: Start all services (podman-compose)
          when: hotstack_deployment_method == 'podman-compose'
          args:
            chdir: "{{ hotstack_os_dir }}"
            executable: /bin/bash
          ansible.builtin.shell: |
            set -o pipefail
            make start 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_start.log

        - name: Install and start systemd services
          when: hotstack_deployment_method == 'systemd'
          args:
            chdir: "{{ hotstack_os_dir }}"
            executable: /bin/bash
          ansible.builtin.shell: |
            set -o pipefail
            make install 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_install.log

        - name: Wait for systemd services to be ready
          when: hotstack_deployment_method == 'systemd'
          ansible.builtin.systemd:
            name: hotstack-os.target
            state: started
          register: systemd_status
          until: systemd_status is succeeded
          retries: 60
          delay: 5

    - name: Run post-setup to create project and upload images
      args:
        chdir: "{{ hotstack_os_dir }}"
        executable: /bin/bash
      environment:
        HOTSTACK_NO_PROGRESS: "1"
      ansible.builtin.shell: |
        set -o pipefail
        make post-setup 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_post-setup.log

    - name: Run smoke test
      args:
        chdir: "{{ hotstack_os_dir }}"
        executable: /bin/bash
      ansible.builtin.shell: |
        set -o pipefail
        make smoke-test 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_smoke-test.log
