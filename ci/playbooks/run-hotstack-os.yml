---
- name: Test hotstack-os containerized OpenStack devsetup
  hosts: all
  vars:
    hotstack_os_dir: "{{ ansible_user_dir }}/{{ zuul.project.src_dir }}/devsetup/hotstack-os"
  tasks:

    - name: Install EPEL repository
      become: true
      ansible.builtin.dnf:
        name: epel-release
        state: present

    - name: Install essential packages for build
      become: true
      ansible.builtin.dnf:
        name:
          - podman
          - podman-compose
          - make
          - apt-cacher-ng
        state: present

    - name: Start and enable apt-cacher-ng service
      become: true
      ansible.builtin.systemd:
        name: apt-cacher-ng
        state: started
        enabled: true

    - name: Generate SSH keypair for smoke test
      ansible.builtin.command:
        cmd: ssh-keygen -t ed25519 -f {{ ansible_user_dir }}/.ssh/id_ed25519 -N "" -C "zuul@ci"
        creates: "{{ ansible_user_dir }}/.ssh/id_ed25519.pub"

    - name: Create log directory
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/zuul-output/logs"
        state: directory
        mode: '0755'

    - name: Copy .env.example to .env if not exists
      ansible.builtin.copy:
        src: "{{ hotstack_os_dir }}/.env.example"
        dest: "{{ hotstack_os_dir }}/.env"
        remote_src: true
        force: false
        mode: '0644'

    - name: Configure APT_PROXY for CI build
      ansible.builtin.lineinfile:
        path: "{{ hotstack_os_dir }}/.env"
        regexp: '^APT_PROXY='
        line: 'APT_PROXY=http://host.containers.internal:3142'

    - name: Configure BUILD_PARALLEL for CI build
      ansible.builtin.lineinfile:
        path: "{{ hotstack_os_dir }}/.env"
        regexp: '^BUILD_PARALLEL='
        line: 'BUILD_PARALLEL=8'

    - name: Verify apt-cacher-ng is running and accessible
      ansible.builtin.uri:
        url: http://localhost:3142/acng-report.html
        status_code: 200
      retries: 5
      delay: 2
      register: apt_cache_check

    - name: Test apt-cacher-ng connectivity from container context
      ansible.builtin.command:
        cmd: >-
          podman run --rm debian:bookworm-slim sh -c
          "curl -f -s -o /dev/null http://host.containers.internal:3142/
          && echo 'Proxy reachable' || echo 'Proxy NOT reachable'"
      register: container_proxy_test
      changed_when: false

    - name: Display container proxy test result
      ansible.builtin.debug:
        msg: "{{ container_proxy_test.stdout }}"

    - name: Build, setup, and start hotstack-os services
      become: true
      block:
        - name: Install dependencies
          args:
            chdir: "{{ hotstack_os_dir }}"
            executable: /bin/bash
          ansible.builtin.shell: |
            set -o pipefail
            make install-deps 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_install-deps.log

        - name: Build container images (with retry logic)
          args:
            chdir: "{{ hotstack_os_dir }}"
            executable: /bin/bash
          ansible.builtin.shell: |
            set -o pipefail

            # Try up to 3 times: first 2 without cleanup, then cleanup and try once more
            for attempt in 1 2 3; do
              echo "=== Build attempt $attempt of 3 ==="

              if make build 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_build_attempt_${attempt}.log; then
                echo "=== Build succeeded on attempt $attempt ==="
                exit 0
              fi

              echo "=== Build attempt $attempt failed ==="

              # Only cleanup after second failure (before third attempt)
              if [ $attempt -eq 2 ]; then
                echo "=== Cleaning up podman state before final retry ==="
                podman rm -af 2>&1 | tee -a {{ ansible_user_dir }}/zuul-output/logs/podman_cleanup.log || true
                podman rmi -af 2>&1 | tee -a {{ ansible_user_dir }}/zuul-output/logs/podman_cleanup.log || true
                podman system prune -af --volumes 2>&1 | tee -a {{ ansible_user_dir }}/zuul-output/logs/podman_cleanup.log || true

                # Random delay between 30-60 seconds
                delay=$((30 + RANDOM % 31))
                echo "=== Waiting ${delay} seconds before final retry ==="
                sleep $delay
              elif [ $attempt -eq 1 ]; then
                # Short delay between first and second attempt
                echo "=== Waiting 10 seconds before retry ==="
                sleep 10
              fi
            done

            echo "=== All 3 build attempts failed ==="
            exit 1
          register: build_result

        - name: Install OpenStack client packages
          args:
            chdir: "{{ hotstack_os_dir }}"
            executable: /bin/bash
          ansible.builtin.shell: |
            set -o pipefail
            make install-client 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_install-client.log

        - name: Install and start systemd services
          args:
            chdir: "{{ hotstack_os_dir }}"
            executable: /bin/bash
          ansible.builtin.shell: |
            set -o pipefail
            make install 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_install.log

        - name: Enable and start systemd services
          ansible.builtin.systemd:
            name: hotstack-os.target
            state: started
            enabled: true

        - name: Wait for all hotstack-os services to be active
          ansible.builtin.command:
            cmd: systemctl is-active hotstack-os.target
          register: target_status
          until: target_status.rc == 0
          retries: 60
          delay: 5
          changed_when: false

    - name: Run post-setup to create project and upload images
      args:
        chdir: "{{ hotstack_os_dir }}"
        executable: /bin/bash
      environment:
        HOTSTACK_NO_PROGRESS: "1"
      ansible.builtin.shell: |
        set -o pipefail
        make post-setup 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_post-setup.log

    - name: Run smoke test
      args:
        chdir: "{{ hotstack_os_dir }}"
        executable: /bin/bash
      ansible.builtin.shell: |
        set -o pipefail
        make smoke-test 2>&1 | tee {{ ansible_user_dir }}/zuul-output/logs/make_smoke-test.log
