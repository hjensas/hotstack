# HAProxy configuration for hotstack-os
# Provides unified entry point for all OpenStack services

global
    log stdout format raw local0 info
    maxconn 4096
    # Avoid daemon mode - run in foreground for containers
    # daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch
    retries 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn 3000

# Keystone - Identity Service (port 5000)
frontend keystone_frontend
    bind *:5000
    default_backend keystone_backend

backend keystone_backend
    option httpchk GET /v3
    http-check expect status 200
    server keystone KEYSTONE_IP:5000 check inter 5s fall 3 rise 2

# Glance - Image Service (port 9292)
frontend glance_frontend
    bind *:9292
    default_backend glance_backend

backend glance_backend
    option httpchk GET /
    http-check expect status 300
    server glance GLANCE_IP:9292 check inter 5s fall 3 rise 2

# Placement - Placement Service (port 8778)
frontend placement_frontend
    bind *:8778
    default_backend placement_backend

backend placement_backend
    option httpchk GET /
    http-check expect status 200
    server placement PLACEMENT_IP:8778 check inter 5s fall 3 rise 2

# Nova - Compute Service (port 8774)
frontend nova_frontend
    bind *:8774
    default_backend nova_backend

backend nova_backend
    option httpchk GET /
    http-check expect status 200
    server nova-api NOVA_API_IP:8774 check inter 5s fall 3 rise 2

# Neutron - Network Service (port 9696)
frontend neutron_frontend
    bind *:9696
    default_backend neutron_backend

backend neutron_backend
    option httpchk GET /
    http-check expect status 200
    server neutron NEUTRON_SERVER_IP:9696 check inter 5s fall 3 rise 2

# Cinder - Block Storage Service (port 8776)
frontend cinder_frontend
    bind *:8776
    default_backend cinder_backend

backend cinder_backend
    option httpchk GET /
    http-check expect status 300
    server cinder CINDER_API_IP:8776 check inter 5s fall 3 rise 2

# Heat - Orchestration Service (port 8004)
frontend heat_frontend
    bind *:8004
    default_backend heat_backend

backend heat_backend
    option httpchk GET /
    http-check expect status 300
    server heat HEAT_API_IP:8004 check inter 5s fall 3 rise 2

# Nova VNC Proxy (port 6080)
frontend novnc_frontend
    bind *:6080
    mode tcp
    option tcplog
    default_backend novnc_backend

backend novnc_backend
    mode tcp
    option tcp-check
    server novnc NOVA_NOVNCPROXY_IP:6080 check inter 5s fall 3 rise 2

# HAProxy stats interface (optional, for monitoring)
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
