---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

version: '3.8'

services:
  # Infrastructure Services
  dnsmasq:
    build:
      context: ./containerfiles
      dockerfile: dnsmasq.containerfile
    container_name: hotstack-os-dnsmasq
    restart: unless-stopped
    hostname: dnsmasq
    network_mode: host
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf:ro,z
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 53"]
      interval: 10s
      timeout: 5s
      retries: 3

  haproxy:
    build:
      context: ./containerfiles
      dockerfile: haproxy.containerfile
    container_name: hotstack-os-haproxy
    restart: unless-stopped
    hostname: haproxy
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro,z
    ports:
      - "${BREX_IP}:5000:5000"   # Keystone
      - "${BREX_IP}:9292:9292"   # Glance
      - "${BREX_IP}:8778:8778"   # Placement
      - "${BREX_IP}:8774:8774"   # Nova
      - "${BREX_IP}:9696:9696"   # Neutron
      - "${BREX_IP}:8776:8776"   # Cinder
      - "${BREX_IP}:8004:8004"   # Heat
      - "${BREX_IP}:6080:6080"   # Nova VNC
      - "${BREX_IP}:8404:8404"   # HAProxy Stats
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 8404"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - openstack

  mariadb:
    image: docker.io/library/mariadb:11.4
    container_name: hotstack-os-mariadb
    restart: unless-stopped
    command: --innodb-buffer-pool-size=32M --max-connections=250
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - ${HOTSTACK_DATA_DIR}/mysql:/var/lib/mysql:z
      - ${HOTSTACK_DATA_DIR}/runtime/scripts/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro,z
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      openstack:
        ipv4_address: ${MARIADB_IP}

  rabbitmq:
    image: docker.io/library/rabbitmq:3.13
    container_name: hotstack-os-rabbitmq
    restart: unless-stopped
    hostname: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    volumes:
      - ${HOTSTACK_DATA_DIR}/rabbitmq:/var/lib/rabbitmq:z
      - ${HOTSTACK_DATA_DIR}/runtime/config/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro,z
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      openstack:
        ipv4_address: ${RABBITMQ_IP}

  memcached:
    image: docker.io/library/memcached:1.6-alpine
    container_name: hotstack-os-memcached
    restart: unless-stopped
    command: memcached -m 64
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "11211"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      openstack:
        ipv4_address: ${MEMCACHED_IP}

  # OpenStack Services - Phase 1: Identity
  keystone:
    build:
      context: ./containerfiles
      dockerfile: keystone.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
    container_name: hotstack-os-keystone
    restart: unless-stopped
    hostname: keystone
    depends_on:
      mariadb:
        condition: service_healthy
      memcached:
        condition: service_healthy
      dnsmasq:
        condition: service_healthy
      haproxy:
        condition: service_healthy
    environment:
      OSLO_LOCKUTILS_ENABLED: "false"
      KEYSTONE_DB_PASSWORD: ${DB_PASSWORD}
      KEYSTONE_ADMIN_PASSWORD: ${KEYSTONE_ADMIN_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      REGION_NAME: ${REGION_NAME}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/keystone/keystone.conf:/etc/keystone/keystone.conf:ro,z
      - ${HOTSTACK_DATA_DIR}/keystone/fernet-keys:/etc/keystone/fernet-keys:z
      - ${HOTSTACK_DATA_DIR}/keystone/credential-keys:/etc/keystone/credential-keys:z
      - ${HOTSTACK_DATA_DIR}/runtime/scripts/common.sh:/usr/local/lib/common.sh:ro,z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/v3"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      openstack:
        ipv4_address: ${KEYSTONE_IP}

  # Phase 2: Image Storage
  glance:
    build:
      context: ./containerfiles
      dockerfile: glance.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
    container_name: hotstack-os-glance
    restart: unless-stopped
    hostname: glance
    depends_on:
      mariadb:
        condition: service_healthy
      keystone:
        condition: service_healthy
      dnsmasq:
        condition: service_healthy
      haproxy:
        condition: service_healthy
    environment:
      GLANCE_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      KEYSTONE_ADMIN_PASSWORD: ${KEYSTONE_ADMIN_PASSWORD}
      REGION_NAME: ${REGION_NAME}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/glance/glance-api.conf:/etc/glance/glance-api.conf:ro,z
      - ${HOTSTACK_DATA_DIR}/glance/images:/var/lib/glance/images:U,z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9292/"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      openstack:
        ipv4_address: ${GLANCE_IP}

  # Phase 3: Placement (Resource Tracking)
  placement:
    build:
      context: ./containerfiles
      dockerfile: placement.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
    container_name: hotstack-os-placement
    restart: unless-stopped
    hostname: placement
    depends_on:
      mariadb:
        condition: service_healthy
      keystone:
        condition: service_healthy
      dnsmasq:
        condition: service_healthy
      haproxy:
        condition: service_healthy
    environment:
      PLACEMENT_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      KEYSTONE_ADMIN_PASSWORD: ${KEYSTONE_ADMIN_PASSWORD}
      REGION_NAME: ${REGION_NAME}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/placement/placement.conf:/etc/placement/placement.conf:ro,z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8778/"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      openstack:
        ipv4_address: ${PLACEMENT_IP}

  # Phase 3: Compute Services
  nova-api:
    build:
      context: ./containerfiles
      dockerfile: nova.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: api
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-nova-api
    restart: unless-stopped
    hostname: nova
    depends_on:
      mariadb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keystone:
        condition: service_healthy
      placement:
        condition: service_healthy
      dnsmasq:
        condition: service_healthy
      haproxy:
        condition: service_healthy
    environment:
      NOVA_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      KEYSTONE_ADMIN_PASSWORD: ${KEYSTONE_ADMIN_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
      METADATA_SECRET: ${SERVICE_PASSWORD}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/nova/nova.conf:/etc/nova/nova.conf:ro,z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8774/"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    entrypoint: ["/usr/local/bin/nova-api-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${NOVA_API_IP}

  nova-conductor:
    build:
      context: ./containerfiles
      dockerfile: nova.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: conductor
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-nova-conductor
    restart: unless-stopped
    hostname: nova-conductor
    depends_on:
      nova-api:
        condition: service_healthy
    environment:
      NOVA_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
      METADATA_SECRET: ${SERVICE_PASSWORD}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/nova/nova.conf:/etc/nova/nova.conf:ro,z
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/exe"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    entrypoint: ["/usr/local/bin/nova-conductor-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${NOVA_CONDUCTOR_IP}

  nova-scheduler:
    build:
      context: ./containerfiles
      dockerfile: nova.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: scheduler
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-nova-scheduler
    restart: unless-stopped
    hostname: nova-scheduler
    depends_on:
      nova-api:
        condition: service_healthy
    environment:
      NOVA_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
      METADATA_SECRET: ${SERVICE_PASSWORD}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/nova/nova.conf:/etc/nova/nova.conf:ro,z
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/exe"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    entrypoint: ["/usr/local/bin/nova-scheduler-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${NOVA_SCHEDULER_IP}

  nova-compute:
    build:
      context: ./containerfiles
      dockerfile: nova.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: compute
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-nova-compute
    restart: unless-stopped
    hostname: nova-compute
    privileged: true
    user: root
    security_opt:
      - label=type:spc_t
    network_mode: host
    depends_on:
      nova-api:
        condition: service_healthy
      nova-conductor:
        condition: service_healthy
    environment:
      NOVA_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
      METADATA_SECRET: ${SERVICE_PASSWORD}
    extra_hosts:
      - "mariadb:${MARIADB_IP}"
      - "rabbitmq:${RABBITMQ_IP}"
      - "memcached:${MEMCACHED_IP}"
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/nova/nova.conf:/etc/nova/nova.conf:ro,z
      - /var/run/libvirt:/var/run/libvirt
      - /etc/iscsi:/etc/iscsi:z
      - /var/lib/iscsi:/var/lib/iscsi:z
      - /run/openvswitch:/run/openvswitch
      - ${HOTSTACK_DATA_DIR:-/var/lib/hotstack-os}/nova:/var/lib/nova:z
      - ${NOVA_INSTANCES_PATH:-/var/lib/hotstack-os/nova-instances}:${NOVA_INSTANCES_PATH:-/var/lib/hotstack-os/nova-instances}:shared
      - ${NOVA_NFS_MOUNT_POINT_BASE:-/var/lib/hotstack-os/nova-mnt}:${NOVA_NFS_MOUNT_POINT_BASE:-/var/lib/hotstack-os/nova-mnt}:shared
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    healthcheck:
      test: ["CMD-SHELL", "/usr/local/bin/nova-compute-healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    entrypoint: ["/usr/local/bin/nova-compute-entrypoint.sh"]

  nova-novncproxy:
    build:
      context: ./containerfiles
      dockerfile: nova.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: api
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-nova-novncproxy
    restart: unless-stopped
    hostname: nova-novncproxy
    depends_on:
      nova-api:
        condition: service_healthy
    environment:
      NOVA_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/nova/nova.conf:/etc/nova/nova.conf:ro,z
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/exe && ss -tln | grep -q :6080"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    entrypoint: ["/usr/local/bin/nova-novncproxy-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${NOVA_NOVNCPROXY_IP}

  # Phase 4: OVN Networking Control Plane
  ovn-northd:
    build:
      context: ./containerfiles
      dockerfile: ovn.containerfile
      args:
        SERVICE_TYPE: northd
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-ovn-northd
    restart: unless-stopped
    hostname: ovn-northd
    privileged: true
    volumes:
      - ${HOTSTACK_DATA_DIR}/ovn:/var/lib/ovn:z
      - ovn-run:/run/ovn
    healthcheck:
      test:
        - "CMD-SHELL"
        - "test -f /run/ovn/ovn-northd.pid && kill -0 $(cat /run/ovn/ovn-northd.pid) &&
          ss -tln | grep -q :6641 && ss -tln | grep -q :6642"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    entrypoint: ["/usr/local/bin/ovn-northd-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${OVN_NORTHD_IP}

  ovn-controller:
    build:
      context: ./containerfiles
      dockerfile: ovn.containerfile
      args:
        SERVICE_TYPE: controller
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-ovn-controller
    restart: unless-stopped
    hostname: ovn-controller
    privileged: true
    network_mode: host
    user: root
    security_opt:
      - label=disable
    depends_on:
      ovn-northd:
        condition: service_healthy
    environment:
      OVN_ENCAP_IP: ${BREX_IP}
      CHASSIS_HOSTNAME: ${CHASSIS_HOSTNAME}
    volumes:
      - /run/openvswitch:/run/openvswitch
      - ovn-run:/run/ovn
    healthcheck:
      test: ["CMD-SHELL", "test -f /run/ovn/ovn-controller.pid && kill -0 $(cat /run/ovn/ovn-controller.pid)"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    entrypoint: ["/usr/local/bin/ovn-controller-entrypoint.sh"]

  # Phase 4: Neutron Services
  neutron-server:
    build:
      context: ./containerfiles
      dockerfile: neutron.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: server
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-neutron-server
    restart: unless-stopped
    hostname: neutron
    depends_on:
      mariadb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keystone:
        condition: service_healthy
      ovn-northd:
        condition: service_healthy
      dnsmasq:
        condition: service_healthy
      haproxy:
        condition: service_healthy
    environment:
      NEUTRON_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      KEYSTONE_ADMIN_PASSWORD: ${KEYSTONE_ADMIN_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/neutron/neutron.conf:/etc/neutron/neutron.conf:ro,z
      - ${HOTSTACK_DATA_DIR}/runtime/config/neutron/plugins/ml2/ml2_conf.ini:/etc/neutron/plugins/ml2/ml2_conf.ini:ro,z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    entrypoint: ["/usr/local/bin/neutron-server-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${NEUTRON_SERVER_IP}

  neutron-ovn-metadata-agent:
    build:
      context: ./containerfiles
      dockerfile: neutron.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: metadata
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-neutron-metadata
    restart: unless-stopped
    hostname: neutron-metadata
    privileged: true
    network_mode: host
    user: root
    depends_on:
      neutron-server:
        condition: service_healthy
      ovn-controller:
        condition: service_healthy
    environment:
      NEUTRON_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      METADATA_SECRET: ${SERVICE_PASSWORD}
      NEUTRON_URL: http://${NEUTRON_SERVER_IP}:9696/
      OVN_SB_IP: ${OVN_NORTHD_IP}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/neutron/neutron.conf:/etc/neutron/neutron.conf:ro,z
      - ${HOTSTACK_DATA_DIR}/runtime/config/neutron/neutron_ovn_metadata_agent.ini:/etc/neutron/neutron_ovn_metadata_agent.ini:ro,z
      - /run/openvswitch:/run/openvswitch
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/exe"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s
    entrypoint: ["/usr/local/bin/neutron-ovn-metadata-agent-entrypoint.sh"]

  # Phase 5: Block Storage Services
  cinder-api:
    build:
      context: ./containerfiles
      dockerfile: cinder.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: api
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-cinder-api
    restart: unless-stopped
    hostname: cinder
    depends_on:
      mariadb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keystone:
        condition: service_healthy
      dnsmasq:
        condition: service_healthy
      haproxy:
        condition: service_healthy
    environment:
      CINDER_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      KEYSTONE_ADMIN_PASSWORD: ${KEYSTONE_ADMIN_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/cinder/cinder.conf:/etc/cinder/cinder.conf:ro,z
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -s http://localhost:8776/ >/dev/null 2>&1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    entrypoint: ["/usr/local/bin/cinder-api-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${CINDER_API_IP}

  cinder-scheduler:
    build:
      context: ./containerfiles
      dockerfile: cinder.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: scheduler
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-cinder-scheduler
    restart: unless-stopped
    hostname: cinder-scheduler
    depends_on:
      cinder-api:
        condition: service_healthy
    environment:
      CINDER_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/cinder/cinder.conf:/etc/cinder/cinder.conf:ro,z
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/exe"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    entrypoint: ["/usr/local/bin/cinder-scheduler-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${CINDER_SCHEDULER_IP}

  cinder-volume:
    build:
      context: ./containerfiles
      dockerfile: cinder.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: volume
        APT_PROXY: ${APT_PROXY:-}
    container_name: hotstack-os-cinder-volume
    restart: unless-stopped
    hostname: cinder-volume
    privileged: true
    user: root
    network_mode: host
    depends_on:
      cinder-api:
        condition: service_healthy
      cinder-scheduler:
        condition: service_healthy
    environment:
      CINDER_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
    extra_hosts:
      - "mariadb:${MARIADB_IP}"
      - "rabbitmq:${RABBITMQ_IP}"
      - "memcached:${MEMCACHED_IP}"
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/cinder/cinder.conf:/etc/cinder/cinder.conf:ro,z
      - ${HOTSTACK_DATA_DIR}/runtime/config/cinder/nfs_shares:/etc/cinder/nfs_shares:ro,z
      - ${HOTSTACK_DATA_DIR}/cinder:/var/lib/cinder:z
    healthcheck:
      test: ["CMD-SHELL", "cinder-volume --version 2>/dev/null || test -f /proc/1/exe"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    entrypoint: ["/usr/local/bin/cinder-volume-entrypoint.sh"]


  # Phase 6: Orchestration Services
  heat-api:
    build:
      context: ./containerfiles
      dockerfile: heat.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: api
    container_name: hotstack-os-heat-api
    restart: unless-stopped
    hostname: heat
    depends_on:
      mariadb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keystone:
        condition: service_healthy
      dnsmasq:
        condition: service_healthy
      haproxy:
        condition: service_healthy
    environment:
      HEAT_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      KEYSTONE_ADMIN_PASSWORD: ${KEYSTONE_ADMIN_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/heat/heat.conf:/etc/heat/heat.conf:ro,z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    entrypoint: ["/usr/local/bin/heat-api-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${HEAT_API_IP}

  heat-engine:
    build:
      context: ./containerfiles
      dockerfile: heat.containerfile
      args:
        OPENSTACK_BRANCH: ${OPENSTACK_BRANCH}
        SERVICE_TYPE: engine
    container_name: hotstack-os-heat-engine
    restart: unless-stopped
    hostname: heat-engine
    depends_on:
      heat-api:
        condition: service_healthy
    environment:
      HEAT_DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_PASSWORD: ${SERVICE_PASSWORD}
      RABBITMQ_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_PASS: ${RABBITMQ_DEFAULT_PASS}
      REGION_NAME: ${REGION_NAME}
    volumes:
      - ${HOTSTACK_DATA_DIR}/runtime/config/heat/heat.conf:/etc/heat/heat.conf:ro,z
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/exe"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    entrypoint: ["/usr/local/bin/heat-engine-entrypoint.sh"]
    networks:
      openstack:
        ipv4_address: ${HEAT_ENGINE_IP}

networks:
  openstack:
    driver: bridge
    ipam:
      config:
        - subnet: ${CONTAINER_NETWORK}
    x-podman.dns:
      - ${BREX_IP}

volumes:
  ovn-run:
